---
title: "Changing the water model"
output:
  html_vignette:
    mathjax: null
vignette: >
  %\VignetteIndexEntry{4 - Changing the water model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: logKcalc.bib
csl: elementa.csl
---

<!-- https://gomakethings.com/how-to-break-an-image-out-of-its-parent-container-with-css/ -->
<style>
@media (min-width: 700px) {
  .full-width {
    left: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    max-width: 100vw;
    position: relative;
    right: 50%;
    width: 100vw;
  }
}
@media (min-width: 1020px) {
  .full-width {
    left: 50vw; /* fallback if needed */
    left: calc(50vw - 160px);
    width: 1000px;
    position: relative;
    background-color: #9ecff7;
    padding:10px;
  }
}
</style>
<script>
function myFunction() {
  // https://www.w3schools.com/howto/howto_js_toggle_hide_show.asp
  var x = document.getElementById("myDIV");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
  // https://stackoverflow.com/questions/10671174/changing-button-text-onclick
  // https://stackoverflow.com/questions/7035842/how-to-change-the-buttons-text-using-javascript
  var elem = document.getElementById("myButton");
  if (elem.innerText=="Hide results") elem.innerText = "Show results";
  else elem.innerText = "Hide results";
}
</script>

```{r setup, include=FALSE}
library(logKcalc)
library(knitr)
## colorize messages 20171031
## adapted from https://gist.github.com/yihui/2629886#file-knitr-color-msg-rnw
color_block = function(color) {
  function(x, options) sprintf('<pre style="color:%s">%s</pre>', color, x)
}
knit_hooks$set(warning = color_block('magenta'), error = color_block('red'), message = color_block('blue'))
## use pngquant to optimize PNG images
knit_hooks$set(pngquant = hook_pngquant)
pngquant <- "--speed=1 --quality=0-25"
if (!nzchar(Sys.which("pngquant"))) pngquant <- NULL 
## logK with a thin space 20200627
logK <- "log&thinsp;<i>K</i>"
```

#### This vignette shows a worked example for gold speciation diagrams.

This vignette was compiled with **logKcalc** `r packageDescription("logKcalc")$Version` and **CHNOSZ** `r packageDescription("CHNOSZ")$Version`.

The Deep Earth Water (DEW) model includes correlations for H~2~O and revised thermodynamic parameters of aqueous species for estimating thermodynamic properties to pressure of up to 6 GPa [@SHA14].
This model was used to predict a significant stability region for organic ions, such as acetate and propionate, at high pressures corresponding to upper mantle conditions [@SSH14].

Let us reproduce these calculations by activating the DEW model in CHNOSZ in order to calculate equilibrium constants to update the GWB thermodynamic data file `thermo_12elements.tdat`.
Separate commands are needed to change the water model and load the parameters of the revised Helgeson-Kirkham-Flowers (HKF) equations for aqueous species that are taken from the [DEW spreadsheet](http://www.dewcommunity.org/resources.html).

```{r DEW, message = FALSE}
reset()
water("DEW")
add.obigt("DEW_aq")
# modOBIGT(c("addSUPCRT", "steam"))
```

Note that other changes to the database to add the properties of steam and minerals from SUPCRT92 [@JOH92] are not needed for this calculation.

The `thermo_12elements.tdat` data file includes CH3COO- (acetate) and HCH3COO (acetic acid), which will be updated during the conversion.
We can use the `ispecies` argument to add other species from OBIGT, in particular propanoic acid and propanoate, which were discussed by @SSH14.

```{r ispecies, message = FALSE}
ispecies <- info(c("formic acid", "formate", "propanoic acid", "propanoate"))
```

It is not possible to independently vary pressure in GWB programs; instead, it is expanded in terms of the principal temperatures listed in the thermodynamic data file [@GWB20b].
In order to set up calculations to compare different pressures, we choose a series of closely spaced temperatures that approximate a constant temperature of 600 °C.
The pressures are set to 0.5, 1, 1.5, 2, 2.5, 3, 4, 5 GPa, converted to units of bar.

```{r TP, message = FALSE}
T <- 593:600
P <- c(5000, 10000, 15000, 20000, 25000, 30000, 40000, 50000)
```

Now we perform the conversion.
To calculate the extended term parameter of the Debye-Hückel equation at high pressure (see @MSS13 and @Dic19), we use the `bgamma` method.

```{r logKcalc, eval = FALSE}
infile <- system.file("extdata/thermo_12elements.tdat", package = "logKcalc")
outfile <- file.path(tempdir(), "thermo_OBIGT.tdat")
logKcalc(infile, outfile, T = T, P = P, ispecies = ispecies, DH.method = "bgamma", maxprint = 10)
```

<button id="myButton" onclick="myFunction()">Show results</button>
<div id="myDIV" style="display: none">
```{r logKcalc, echo = FALSE}
```
</div>

#### Scripts and output of GWB runs.

## References
